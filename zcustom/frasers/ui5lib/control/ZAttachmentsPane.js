sap.ui.define(["sap/client/basecontrols/core/CustomPane","sap/m/MessageToast","sap/m/GenericTile","sap/m/GenericTileScope","sap/ui/unified/FileUploader","sap/client/m/util/ImageResizer","sap/client/m/create/QuickCreateTile","sap/m/ScrollContainer","sap/m/LightBox","sap/m/LightBoxItem","zcustom/frasers/ui5lib/ext/ZThumbnailTile","zcustom/frasers/ui5lib/ext/ZThumbnailTileContent","zcustom/frasers/ui5lib/ext/ZImage"],function(e,t,i,a,n,o,s,r,l,h,d,c,m){"use strict";var g=e.extend("zcustom.frasers.ui5lib.control.ZAttachmentsPane",{metadata:{library:"zcustom.frasers.ui5lib",properties:{},aggregations:{browseTile:{type:"sap.client.m.create.QuickCreateTile",multiple:false},cameraTile:{type:"sap.client.m.create.QuickCreateTile",multiple:false},attachments:{type:"sap.m.GenericTile",multiple:true,singularName:"attachment"},tileContainer:{type:"sap.m.ScrollContainer",multiple:false}},events:{}},SMALL_WIDTH_HEIGHT:400,MEDIUM_WIDTH_HEIGHT:600,LARGE_WIDTH_HEIGHT:800,renderer:function(e,t){e.write("<div");e.writeControlData(t);e.addClass("zAttachments");e.writeClasses();e.write(">");e.write("<div style='display : none'>");e.renderControl(t._stdFUoControl);e.write("</div>");e.renderControl(t.getTileContainer());e.write("</div>")},_getCustomParameters:function(){this._primaryPath=this.getParameter("primaryPath")?this.getParameter("primaryPath"):"/Root/AttachmentFolder/AddParams";this._attach2EC=this.getParameter("attach2EC")?this.getParameter("attach2EC"):"COD_Documentlist";this._enableImageProcessor=this.getParameter("enableImageProcessor")?this.getParameter("enableImageProcessor"):"None";this._onFileSelected=this.getParameter("onFileSelected");this._bHideBrowse=this.getParameter("hideBrowse")==="true";this._bHideCamera=this.getParameter("hideCamera")==="true";this._bHideImages=this.getParameter("hideImages")==="true";this._bHideNonImages=this.getParameter("hideNonImages")==="true";this._bMultipleFiles=!(this.getParameter("singleFile")==="true");this._bMultipleFiles=false;this._bAlwaysResize=this.getParameter("alwaysResize")==="true";this._bAlwaysResize=false},_setupThumbnailSize:function(e){var t;if(e){t=$("#"+e).get(0)}if(!t&&(!this._maxThumbnailHeight||!this._maxThumbnailHeight)){t=$("#"+this.getControlPrefixId()+"-browseTile").get(0);if(!t){t=$("#"+this.getControlPrefixId()+"-cameraTile").get(0)}}if(t){if(t.clientWidth&&t.clientHeight){this._maxThumbnailWidth=Math.round(t.clientWidth);this._maxThumbnailHeight=Math.round(t.clientHeight)}else{var i=getComputedStyle(t);if(i){this._maxThumbnailWidth=Math.round(parseFloat(i.width));this._maxThumbnailHeight=Math.round(parseFloat(i.height))}}}},initializePane:function(){this.oController=this.getController();this._oApplication=this._oApplication||this.oController&&this.oController.getApplication&&this.oController.getApplication()||sap.client.getCurrentApplication&&sap.client.getCurrentApplication();if(!this._oApplication.isNewUI()){return}this._oRuntimeEnviroment=this.oController&&this.oController.getRuntimeEnvironment&&this.oController.getRuntimeEnvironment()||this._oApplication.getRuntimeEnvironment();this._getCustomParameters();this.Documents=[];this.Thumbnails=[];this._attachedECController=this._getAttachedECController();if(this._attachedECController){this._onChildControllerAdded();this._DataContainerUpdateFinished()}else{this.oController.getParentController().attachEvent("ChildControllerAdded",this,this._onChildControllerAdded,this)}var e=this._primaryPath;var i=null;var a=this._oRuntimeEnviroment;var s=a.isRunningInContainer();var r=sap.ui.Device.os.ios;var l;var h=this._oApplication.getSettings();if(this._oApplication.isOfflineMode()){l=h.getDefaultImageUploadResolutionClassificationForOffline()}else{l=h.getDefaultImageUploadResolutionClassificationForOnline()}this._setupImageResize(l);var d=this._enableImageProcessor;if(d==="Crop"&&this.oController){var c=a.isRunningOnWindowsContainer();if(!c){jQuery.sap.require("sap.client.basecontrols.core.ImageProcessor");var m=new sap.client.basecontrols.core.ImageProcessor(this,e);this.oController.setImageProcessor(m)}}var g=this._iCompressedWidthHeight&&!this.oController.getImageProcessor();if(g){this.oImageResizer=new o(this._iCompressedWidthHeight,this._iCompressedWidthHeight)}if(false&&(this.oImageResizer||this._oApplication.isOfflineMode())&&window.FilePicker){t.show("new sap.m.Button");this.oFileUploader=new sap.m.Button(this.getControlPrefixId()+"-browseButton",{icon:sap.ui.core.IconPool.getIconURI("open-folder"),press:function(){window.FilePicker.pickOne(function(e){var t="data:"+e.mimeType+";base64,"+e.content;if(this.isImageFile(e)&&this.oImageResizer){this.oImageResizer.resizeImage(t).then(function(t){this._onImageResized(null,t,e.name)}.bind(this),function(i){this._uploadFile(t,e.name)}.bind(this))}else{if(this._oApplication.isOfflineMode()){var i=this._oApplication.getFileTransfer();this._showUploadingDialog();var a={fileKey:"file",fileName:e.name,mimeType:e.type,content:e.content,size:e.size};var n=this.onFileUploadSuccess.bind(this);var o=this.onFileUploadFail.bind(this);i.upload(e.name,null,n,o,a)}else{this._uploadFile(t,e.name)}}}.bind(this))}.bind(this)});this.oFileUploader.addStyleClass("sapClientMButtonFileUploader");i={Visible:"visible",Enabled:"enabled"}}else{this.oFileUploader=new n(this.getControlPrefixId(),{uploadOnChange:false,sameFilenameAllowed:true,buttonOnly:true,sendXHR:true,multiple:this._bMultipleFiles,change:[this._fnFileUploader_Change,this],uploadAborted:function(){this._closeUploadingDialog()}.bind(this),uploadComplete:[this._fnFileUploader_UploadComplete,this],fileSizeExceed:function(e){sap.m.MessageToast.show(sap.client.m.Util.getLocaleText("FileUploadExceedLimitMsg","Exceeds maximum file size of 2MB"))}});this.oFileUploader.setTooltip(sap.client.m.Util.getLocaleText("FileUploader_ToolTip","No file chosen"));i={Visible:"visible",Enabled:"enabled",Text:"buttonText"};if(s&&!r){this.oFileUploader.setIcon(sap.ui.core.IconPool.getIconURI("open-folder"));this.oFileUploader.setIconOnly(true)}}this._stdFUoControl=this.oFileUploader;this._stdFUoControl.addStyleClass("sapClientMFileUpload");this.oTileContainer=(new sap.m.ScrollContainer).addStyleClass("sapUiTinyMargin");this.setTileContainer(this.oTileContainer);this._buildTiles()},_onChildControllerAdded:function(e){if(!this._getAttachedECController()){return}var t=this._attachedECController.getDataContainer();this.fUpdateFinished=$.proxy(this._DataContainerUpdateFinished,this);if(t){t.attachDataContainerUpdateFinished(this.fUpdateFinished)}},destroy:function(){if(!this._getAttachedECController()){return}var e=this._attachedECController.getDataContainer();if(this.fUpdateFinished){if(e){e.detachDataContainerUpdateFinished(this.fUpdateFinished)}this.fUpdateFinished=null}},_fnFileUploader_Change:function(e){var t=e.mParameters;if(t&&!t.newValue){return}if(this.isImageFileUploader(e.oSource)&&this.oImageResizer){var i={mParameters:e.mParameters,oSource:e.oSource};var a=e.mParameters.files[0];this.oImageResizer.resizeImageFile(a).then(function(e){this._onImageResized(i,e)}.bind(this),function(e){this._onFileChange(i)}.bind(this))}else{this._onFileChange(e)}},_fnFileUploader_UploadComplete:function(e){var t=this._primaryPath;this._closeUploadingDialog();if(!this._getAttachedECController()){return}var i=e.mParameters.response||e.mParameters.responseRaw;if(!i){return}i=unescape(decodeURI(i));i=i.replace(/[\r]/g,"");var a=i.split("\n");if(a.length===3){var n=a[0].split("=")[1];var o=a[1].split("=")[1];var s=a[2].split("=")[1];var r=this._attachedECController.getDataContainer();if(sap.ui.Device.os.ios){var l=sap.client.util.Util.createGuid();var h=o.split(".");if(h.length<2){o=o+"-"+l}else{var d=h.pop();var c=h.pop();o=c+"-"+l+"."+d}}r.setProperty(t+"/content","id="+n,this.getBindingContext());r.setProperty(t+"/fileName",o,this.getBindingContext());r.setProperty(t+"/fileSize",s,this.getBindingContext());r.checkUpdate(t+"/fileName.FormattedValue")}var m;if(e&&e.getSource){m=new sap.client.evt.EventContext(e.getSource())}this._onFileSelected=this.___checkAndCreateEH(this._onFileSelected);var g=this._onFileSelected;if(g){this._attachedECController.getEventProcessor().handleEvent(g,m)}},_getAttachedECController:function(){if(!this._attachedECController){if(this.oController&&this.oController.getParentController()&&this.oController.getParentController().getChildController(this._attach2EC)){this._attachedECController=this.oController.getParentController().getChildController(this._attach2EC)}}return this._attachedECController},_DataContainerUpdateFinished:function(){if(!this._getAttachedECController()){return}var e=this._attachedECController.getDataContainer();var t=e.getDataObject("/Root/AttachmentFolder/DocumentList");var i=t.getCount();if(i!==this.Documents.length){this.Documents=[];var a={};var n=[];var o;for(o=0;o<i;o++){n[t.getDataListBindingContext(o).sRowPath]="/Root/AttachmentFolder/DocumentList/"+o}var s;for(s=0;s<i;s++){var r=t.getRow(s);if(r){a={};a.RowIndex=r.getMember("@RowIndex").getValue();a.NodeID=r.getMember("NodeID").getValue();a.FileName=r.getMember("FileName").getValue();a.MimeCode=r.getMember("MimeCode").getValue();a.FileContentURI=this._checkAndAdjustImageURL(r.getMember("FileContentURI").getValue());a.ThumbnailURL=r.getMember("ThumbnailURL").getValue();a.CreatedOn=r.getMember("CreatedOn").getValue();a.ChangedOn=r.getMember("ChangedOn").getValue();a._sNodeId=r.getNodeId();a._sPath=r.getPath();a.DocumentListPath=n[a._sPath];this.Documents.push(a)}}this.Documents.sort(function(e,t){return t.ChangedOn-e.ChangedOn});this._buildTiles()}},_checkAndAdjustImageURL:function(e){var t="";if(e&&e.indexOf("/ap/ds/wd/doc/")===0){try{t=this._oApplication.getHostUrl()+"/sap("+this.oController.getSession().getSessionID()+")"+e}catch(i){t=e}}else{t=e}return t},_buildTiles:function(){if(!this.oTileContainer){return}this.oTileContainer.destroyContent();if(!this.getBrowseTile()){if(!this._bHideBrowse){var e=new sap.client.m.create.QuickCreateTile(this.getControlPrefixId()+"-browseTile",{text:"Browse",icon:"sap-icon://open-folder",press:function(){document.getElementById(this.getControlPrefixId()+"-fu").click()}.bind(this)}).addStyleClass("sapClientMQCTile sapMGT OneByOne sapUshellTile");this.setBrowseTile(e);this.oTileContainer.addContent(e)}}else{this.oTileContainer.addContent(this.getBrowseTile())}if(navigator.camera){if(!this.getCameraTile()){if(!this._bHideCamera){var t=new sap.client.m.create.QuickCreateTile(this.getControlPrefixId()+"-cameraTile",{text:"Camera",icon:"sap-icon://add-photo",press:[this.onPictureButtonPress,this]}).addStyleClass("sapClientMQCTile sapMGT OneByOne sapUshellTile");this.setCameraTile(t);this.oTileContainer.addContent(t)}}else{this.oTileContainer.addContent(this.getCameraTile())}}var i=this.Documents.length;for(var a=0;a<i;a++){var n=this.Documents[a];if(this.isImageMimeCode(n.MimeCode)){if(!this._bHideImages){var o=new sap.m.LightBox;var s=new sap.m.LightBoxItem({imageSrc:n.FileContentURI,title:n.FileName});o.addImageContent(s);var r=this.Thumbnails[n.NodeID];var l=r?r:n.FileContentURI;var h=new m({densityAware:false,src:l});h.setDetailBox(o);h.addCustomData(new sap.ui.core.CustomData({key:"_Document",value:n}));if(!r){h.attachLoad(this._imageOnLoad,this)}var g=new c;g.setContent(h);var p=new d(this.getControlPrefixId()+"-attaimg-"+n.NodeID,{press:[this._tilePressed,this]}).addStyleClass("sapUshellTile");p.addTileContent(g);p._oDocument=n;this.addAttachment(p);this.oTileContainer.addContent(p)}}else{if(!this._bHideNonImages){var u=this._getIconFromFilename(n.FileName);var f=new sap.m.ImageContent({src:u});var C=new sap.m.TileContent;C.setContent(f);var _=new sap.m.GenericTile(this.getControlPrefixId()+"-atta-"+n.NodeID,{header:n.FileName,press:[this._tilePressed,this]}).addStyleClass("sapUshellTile");_.addTileContent(C);_._oDocument=n;this.addAttachment(_);this.oTileContainer.addContent(_)}}}},_convertRemToPixels:function(e){return e*parseFloat(getComputedStyle(document.documentElement).fontSize)},_imageOnLoad:function(e){var t;try{t=e.getSource().getDomRef().children[1];if(!this._maxThumbnailHeight||!this._maxThumbnailWidth){this._setupThumbnailSize(t.getSource().getParent().getParent().getId());if(!this._maxThumbnailHeight||!this._maxThumbnailWidth){return}}}catch(e){return}var i=t.naturalWidth;var a=t.naturalHeight;var n,o;var s;var r=i>this._maxThumbnailWidth||a>this._maxThumbnailHeight;var l={};l=t;if(r){var h=document.createElement("canvas");h.id="canvasResize";h.width=i;h.height=a;if(i>a){n=Math.round(i*(this._maxThumbnailHeight/a));o=this._maxThumbnailHeight}else{n=this._maxThumbnailWidth;o=Math.round(a*(this._maxThumbnailWidth/i))}h.width=n;h.height=o;var d=h.getContext("2d");d.drawImage(l,0,0,h.width,h.height);i=n;a=o;l=h;s=h.toDataURL("image/jpg",.5)}var c=i>this._maxThumbnailWidth&&a===this._maxThumbnailHeight||a>this._maxThumbnailHeight&&i===this._maxThumbnailWidth;if(c){var m=document.createElement("canvas");h.id="canvasCrop";m.width=i;m.height=a;var g,p;if(i>a){g=Math.round((i-this._maxThumbnailWidth)/2);p=0}else{g=0;p=Math.round((a-this._maxThumbnailHeight)/2)}m.width=this._maxThumbnailWidth;m.height=this._maxThumbnailHeight;var u=m.getContext("2d");u.drawImage(l,g,p,this._maxThumbnailWidth,this._maxThumbnailHeight,0,0,this._maxThumbnailWidth,this._maxThumbnailHeight);s=m.toDataURL("image/jpg",.5)}if(s&&s!==t.src){t.src=s;this.Thumbnails[e.getSource().data("_Document").NodeID]=s}},_isDebugMode:function(){var e=window["sap-ui-debug"];return sap.client.getCurrentApplication().isDebugMode()||e},_getUserMedia:function(e,t,i){var a=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;if(a){return a.bind(navigator)(e,t,i)}},_grabVideo:function(){if(!navigator.getUserMedia&&!navigator.webkitGetUserMedia&&!navigator.mozGetUserMedia&&!navigator.msGetUserMedia){t.show("User Media API not supported.");return}var e={video:true};this._getUserMedia(e,function(e){var t=document.querySelector("video");if("srcObject"in t){t.srcObject=e;t.src=(window.URL||window.webkitURL).createObjectURL(e)}else if(navigator.mozGetUserMedia){t.mozSrcObject=e}this._theStream=e}.bind(this),function(e){t.show("Error: "+e)}.bind(this)).bind(this)},_takePhoto:function(){if(!("ImageCapture"in window)){t.show("ImageCapture is not available");return}if(!this._theStream){t.show("Grab the video stream first!");return}var e=new ImageCapture(this._theStream.getVideoTracks()[0]);var i=this;e.takePhoto().then(function(e){var t=document.getElementById("imageTag");t.src=URL.createObjectURL(e);var a="test";i._uploadFile(e,a).bind(i)}).catch(function(e){t.show("Error: "+e)})},_tilePressed:function(e){if(e.getSource()&&e.getSource()._oDocument&&e.getSource()._oDocument.DocumentListPath){var t=e.getParameter("action");var a=e.getSource()._oDocument;if(a){var n=t===i._Action.Remove?"DeleteConfirmation":"";if(!this.isImageMimeCode(a.MimeCode)){n=t===i._Action.Press?"OpenDocument":n}var o=new sap.client.evt.EventContext(e.oSource);if(o&&n){o._sImplicitLeadSelectionPath=a.DocumentListPath;o.addParam(sap.client.evt.EventContext.PARAMETERS.ROW_IDENTIFIER.PATH,"/Root/AttachmentFolder/DocumentList");o._oEventArguments[sap.client.evt.EventContext.PARAMETERS.ROW_IDENTIFIER]=a._sNodeId;this._attachedECController.getEventProcessor().handleEvent(n,o)}}}},onBeforeRendering:function(){},onAfterRendering:function(){this._setupThumbnailSize()},_setupImageResize:function(e){if(e&&(this._oRuntimeEnviroment.isRunningInContainer()||this._bAlwaysResize)){switch(e){case"L":this._iCompressedWidthHeight=this.LARGE_WIDTH_HEIGHT;break;case"M":this._iCompressedWidthHeight=this.MEDIUM_WIDTH_HEIGHT;break;case"S":this._iCompressedWidthHeight=this.SMALL_WIDTH_HEIGHT;break;default:this._iCompressedWidthHeight=null}}},_showUploadingDialog:function(){if(!this._oDialog){this._oDialog=new sap.m.Dialog(this.getControlPrefixId()+"-dialog",{title:sap.client.m.Util.getLocaleText("UploadInProgress","Uploading..."),content:new sap.m.Text(this.getControlPrefixId()+"-text",{text:sap.client.m.Util.getLocaleText("FileUploadingMsg","Uploading file to server, please wait ...")})})}this._oDialog.open()},_closeUploadingDialog:function(){if(this._oDialog){this._oDialog.close()}},_onImageResized:function(e,t,i){var a=i;if(e){var n=e.mParameters.files[0];if(n){a=n.name}}if(this._oApplication.isOfflineMode()){var o=this._dataUriToBlob(t);this._uploadFile(o,a)}else{this._uploadFile(t,a)}},_dataUriToBlob:function(e){var t=e.split(","),i=t[0].match(/:(.*?);/)[1],a=atob(t[1]),n=a.length,o=new Uint8Array(n);while(n--){o[n]=a.charCodeAt(n)}return new Blob([o],{type:i})},_uploadFile:function(e,t){var i=new window.FileTransfer;if(this._oApplication.isOfflineMode()){i=this.getOfflineFileTransfer()}var a=this._oRuntimeEnviroment;var n=a.isRunningInContainer();var o=new window.FileUploadOptions;var s;if(t){s=t}else if(e.name){s=e.name}else{s="file"}o.fileName=s;o.fileKey="file";o.chunkedMode=false;if(typeof e==="string"&&e.match("image.*")){o.mimeType="image/png"}else if(typeof e==="string"&&e.match("data:.*")){o.mimeType=e.split(";")[0].split(":")[1]}else{o.mimeType=e.type}o.headers={Referer:window.location.href};this._showUploadingDialog();var r=this.getUploadURL();var l=this.onFileUploadSuccess.bind(this);var h=this.onFileUploadFail.bind(this);i.upload(e,r,l,h,o)},_onFileChange:function(e){var t;if(this._oApplication.isOfflineMode()){t=this._oApplication.getFileTransfer();this._showUploadingDialog();var i=e.mParameters.files[0];var a={fileKey:"file",fileName:i.name,mimeType:i.type};var n=this.onFileUploadSuccess.bind(this);var o=this.onFileUploadFail.bind(this);t.upload(i,null,n,o,a)}else{t=e.oSource;var s=this.getUploadURL();t.setUploadUrl(s);var r=this.oController.getImageProcessor();if(r){if(this.isImageFileUploader(t)){r.openPreview(s,e)}else{t.upload();r.closePreview(s,e)}}else{this._showUploadingDialog();t.upload()}}},isImageFileUploader:function(e){if(e&&e.oFileUpload){var t=e.oFileUpload.files[0];return this.isImageFile(t)}return false},isImageFile:function(e){if(e&&e.type&&e.type.match("image.*")||e&&e.mimeType&&e.mimeType.match("image.*")){return true}return false},isImageMimeCode:function(e){if(e.match("image.*")){return true}return false},_getIconFromFilename:function(e){var t=this._splitFilename(e).extension;if(jQuery.type(t)==="string"){t=t.toLowerCase()}switch(t){case".bmp":case".jpg":case".jpeg":case".png":return"sap-icon://card";case".csv":case".xls":case".xlsx":return"sap-icon://excel-attachment";case".doc":case".docx":case".odt":return"sap-icon://doc-attachment";case".pdf":return"sap-icon://pdf-attachment";case".ppt":case".pptx":return"sap-icon://ppt-attachment";case".txt":return"sap-icon://document-text";default:return"sap-icon://document"}},_splitFilename:function(e){var t={};var i=e.split(".");if(i.length===1){t.extension="";t.name=i.pop();return t}t.extension="."+i.pop();t.name=i.join(".");return t},getOfflineFileTransfer:function(){if(!this.oOfflineFileTransfer){var e=sap.ui.requireSync("sap/client/setup/offline/FileTransfer");var t=this._oApplication.getOfflineAPI();this.oOfflineFileTransfer=new e(t)}return this.oOfflineFileTransfer},setControlWidth:function(e){if(this.oControl.setWidth){this.oControl.setWidth("100%")}},getUploadURL:function(){var e;var t=this._oApplication.getRepositoryUrl();if(t){e=t.indexOf("/sap/")+4;if(e>=0){var i=this.oController.getSession().getSessionID();t=t.substr(0,e)+"("+i+")"+t.substr(e)}}if(t){e=t.lastIndexOf("/");if(e>=0){t=t.substr(0,e)+"/fileupload"}}return t},uploadComplete:function(e,t,i){if(!this._getAttachedECController()){return}var a=this._primaryPath;if(e!==null&&t!==null&&i!==null){var n=this._attachedECController.getDataContainer();n.setProperty(a+"/content","id="+e,this.getBindingContext());n.setProperty(a+"/fileName",t,this.getBindingContext());n.setProperty(a+"/fileSize",i,this.getBindingContext());n.checkUpdate(a+"/fileName.FormattedValue");if(this.oFileUploader.oFilePath){this.oFileUploader.oFilePath.setValue(t)}}var o;if(this.oFileUploader){o=new sap.client.evt.EventContext(this.oFileUploader)}this._onFileSelected=this.___checkAndCreateEH(this._onFileSelected);var s=this._onFileSelected;if(s){this._attachedECController.getEventProcessor().handleEvent(s,o)}this.oFileUploader.setTooltip(t)},onFileUploadSuccess:function(e){var t=null;var i=null;var a=null;var n=unescape(decodeURI(e.response));n=n.replace(/[\r]/g,"");var o=n.split("\n");if(o.length===3){t=o[0].split("=")[1];i=o[1].split("=")[1];a=o[2].split("=")[1]}this._closeUploadingDialog();this.uploadComplete(t,i,a)},onFileUploadFail:function(e){this._closeUploadingDialog();var t;if(e.exception){t=e.exception}else{t=e.message}this._resetUploader();sap.m.MessageToast.show(sap.client.m.Util.getLocaleText("FileUploadFailMsg","Unable to upload file. ")+" "+t);jQuery.sap.log.info("onFileUploadFail exception "+t)},onTakePictureSuccess:function(e){if(this.oImageResizer){var t=function(t){var i;if(e.startsWith("/")){i="image-"+(new Date).getTime()+".jpg"}else{i=e.replace(/^.*[\\\/]/,"")}this._onImageResized(null,t,i)};var i=function(e){sap.m.MessageToast.show(sap.client.m.Util.getLocaleText("FileUploadFailMsg","Unable to upload file. ")+" "+sap.client.m.Util.getLocaleText("FileUploadImageResizeFailMsg","Failed to resize image"))};if(this._oApplication.isOfflineMode()&&window.FilePicker){var a="data:image/jpeg;base64,"+e;this.oImageResizer.resizeImage(a).then(t.bind(this),i)}else{this.oImageResizer.resizeImagePath(e).then(t.bind(this),i)}}else{var n=this._oApplication.getFileTransfer();var o=new window.FileUploadOptions;var s;if(e.startsWith("/")){o.content=e;o.fileName=(new Date).getTime()+".jpg";s=o.fileName}else{o.fileName=e.replace(/^.*[\\\/]/,"");s=e}o.fileKey="file";o.mimeType="image/jpeg";o.chunkedMode=false;o.headers={Referer:window.location.href};this._showUploadingDialog();var r=this.getUploadURL();var l=this.onFileUploadSuccess.bind(this);var h=this.onFileUploadFail.bind(this);n.upload(s,r,l,h,o)}},onTakePictureFail:function(e){jQuery.sap.log.info("onTakePictureFail for error "+e)},onPictureButtonPress:function(e){if(navigator.camera){var t=navigator.camera.DestinationType.FILE_URI;var i=45;if(this._oApplication.isOfflineMode()&&window.FilePicker){i=10;t=navigator.camera.DestinationType.DATA_URL}var a={quality:i,targetWidth:1024,targetHeight:768,saveToPhotoAlbum:false,destinationType:t};navigator.camera.getPicture(this.onTakePictureSuccess.bind(this),this.onTakePictureFail.bind(this),a)}},_resetUploader:function(){if(!this._getAttachedECController()){return}var e=this._primaryPath;var t=this._attachedECController.getDataContainer();t.setProperty(e+"/content",null,this.getBindingContext());t.setProperty(e+"/fileName",null,this.getBindingContext());t.setProperty(e+"/fileSize",null,this.getBindingContext());if(this.oFileUploader.oFilePath){this.oFileUploader.oFilePath.setValue("")}t.setProperty("/Root/$System/EditMode",false);t.setProperty("/Root/$System/IsThingDirty",false)},___checkAndCreateEH:function(e){var t="ZCEH";var i=e;if(e.length==0||e.lastIndexOf(t,0)==0){return i}if(!this._getAttachedECController()){return i}this._attachedECController.getComponentModel().getEventHandlers();var a=this._attachedECController.getComponentModel().getEventHandler(e);if(a){var n=a._c.findIndex(function(e){return e._n=="WindowAction"&&e._a.action=="Close"});if(n==-1){}else{var o=JSON.parse(JSON.stringify(a));o._a.id=a._a.id.substring(0,a._a.id.length-4)+t;o._c.splice(n,1);i=t+"_"+e;this._attachedECController.getComponentModel()._mEventHandlers[i]=o}}return i}});return g},true);